<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asset Tally</title>
<style>
  body { font-family: Arial, sans-serif; padding: 10px; background: #f4f4f4; }
  h2 { text-align: center; }
  .top-inputs input { width: 100%; padding: 8px; margin-bottom: 5px; font-size: 16px; box-sizing: border-box; }
  .asset-item { background: #007BFF; color: white; margin-bottom: 10px; padding: 10px; border-radius: 10px; }
  .countRow { display: flex; justify-content: flex-start; align-items: center; margin-top: 5px; flex-wrap: wrap; gap: 10px; }
  .reset-btn { background-color: #D70022; color: white; font-weight: bold; border: none; padding: 5px 10px; border-radius: 8px; font-size: 12px; cursor: pointer; }
  .scheduled-box { background-color: #FFD700; padding: 5px 8px; color: black; border-radius: 8px; font-weight: bold; cursor: pointer; text-align: center; min-width: 80px; font-size: 14px; }
  .count { font-size: 28px; font-weight: bold; width: 60px; text-align: center; }
  .plus-btn { font-size: 18px; background-color: #28a745; color: white; border: none; border-radius: 6px; padding: 5px 8px; cursor: pointer; }
  .intervals { margin-top: 5px; padding-left: 10px; }
  .interval { display: flex; justify-content: space-between; margin: 2px 0; }
  .interval input { width: 40%; }
  .control-btn { padding: 8px 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin: 5px; }
  .download-btn { background-color: #28a745; color: white; }
  .reset-all-btn { background-color: #D70022; color: white; }
  .email-btn { background-color: #FFD700; color: black; }
  .total-count { font-size: 18px; font-weight: bold; text-align: center; margin-top: 10px; }
</style>
</head>
<body>

<h2>Asset Tally</h2>
<div class="top-inputs">
  <input type="text" id="siteName" placeholder="Site Name / Address">
  <input type="text" id="date">
</div>

<div id="assetContainer"></div>

<!-- Checklist Section -->
<div style="margin-top:20px; padding:10px; background:#fff; border-radius:10px;">
  <h3 style="margin-bottom:10px;">Site Photos / Documentation</h3>
  
  <label><input type="checkbox"> Photos</label><br>
  <label><input type="checkbox"> Switch Boards</label><br>
  <label><input type="checkbox"> FIP / EWIS</label><br>
  <label><input type="checkbox"> Inside FIP / EWIS</label><br>
  <label><input type="checkbox"> Batteries</label><br>
  <label><input type="checkbox"> Zone Block Plan</label><br>
  <label><input type="checkbox"> Pumpset</label><br>
  <label><input type="checkbox"> Sprinkler System</label><br>
  <label><input type="checkbox"> Hydrant Block Plan</label><br>
  <label><input type="checkbox"> EVAC Diagrams</label><br>
  <label><input type="checkbox"> HVAC Switchboard</label><br>
  <label><input type="checkbox"> Lockbox Location</label><br>
  <label><input type="checkbox"> Anything else notable?</label>
</div>

<div style="margin-top:15px; text-align:center;">
  <button class="control-btn download-btn" onclick="downloadCSV()">Download CSV</button>
  <button class="control-btn reset-all-btn" id="resetAllBtn">Reset All</button>
  <button class="control-btn email-btn" onclick="emailCSV()">Email</button>
</div>

<div class="total-count" id="totalCount">Total Count: 0</div>

<script>
const assets = [
  {name: "Sprinkler", intervals:["Monthly","6 Monthly","Annual","5 Yearly","10 Yearly","25 Yearly"]},
  {name: "Sprinkler - Flow Switches", intervals: []},
  {name: "FIP", intervals:["Monthly","Annual","5 Yearly"]},
  {name: "FIP - No. Zones", intervals: []},
  {name: "FIP - No. Detectors", intervals: []},
  {name: "FIP - EWIS", intervals:["Monthly","Annual","5 Yearly"]}, 
  {name: "Diesel Pumpset", intervals:["Monthly","6 Monthly","Annual","5 Yearly"]},
  {name: "Electric Pumpset", intervals:["Monthly","6 Monthly","Annual","5 Yearly"]},
  {name: "Water Storage Tanks", intervals:["Monthly","6 Monthly","Annual","10 Yearly"]},
  {name: "Emergency & Exit Lights", intervals:["6 Monthly","Annual"]},
  {name: "Hydrants", intervals:["6 Monthly","Annual"]},
  {name: "Fire Hose Reels", intervals:["6 Monthly","Annual"]},
  {name: "Extinguishers", intervals:["6 Monthly","Annual"]},
  {name: "Blankets", intervals:["6 Monthly"]},
  {name: "Smoke Alarms", intervals:["6 Monthly","Annual"]},
  {name: "Fire Doors - Unit Doors", intervals:["6 Monthly","Annual"]},
  {name: "Fire Doors - Common Area", intervals:["6 Monthly","Annual"]},
  {name: "Sliding Fire Door", intervals:["Annual"]},
  {name: "Annual Flow Test", intervals:["Annual"]},
  {name: "E Light Test Facility - Switchboards", intervals:["Annual"]},
  {name: "RCD Testing / Thermo Scanning", intervals:["Annual"]},
  {name: "Warden Training - FSA", intervals:["Annual"]},
  {name: "Compliance Inspection", intervals:["Annual"]},
  {name: "ERP/FEP Review", intervals:["Annual"]},
  {name: "Evac Drill", intervals:["Annual"]},
  {name: "Evac Diagrams - Update/Replace", intervals:["Annual"]},
  {name: "Mechanical Fan Testing", intervals:["Annual"]},
  {name: "Co2 Calibration", intervals:["Annual"]},
  {name: "Stairwell Pressurisation", intervals:["Annual"]},
];

let counts = {};
let toggleState = {};
let resetConfirm = {};
let resetAllConfirm = false;

function render() {
  const container = document.getElementById("assetContainer");
  container.innerHTML = "";
  let total = 0;
  
  assets.forEach(asset => {
    counts[asset.name] = counts[asset.name] || 0;
    toggleState[asset.name] = toggleState[asset.name] || false;
    resetConfirm[asset.name] = resetConfirm[asset.name] || false;

    total += counts[asset.name];

    const item = document.createElement("div");
    item.className = "asset-item";
    
    const title = document.createElement("div");
    title.textContent = asset.name;
    title.style.fontWeight = "bold";
    title.style.fontSize = "18px";
    item.appendChild(title);

    const countRow = document.createElement("div");
    countRow.className = "countRow";

    // Reset button
    const resetBtn = document.createElement("button");
    resetBtn.className = "reset-btn";
    resetBtn.textContent = "Reset";
    resetBtn.onclick = (e) => {
      e.stopPropagation();
      if (!resetConfirm[asset.name]) {
        resetConfirm[asset.name] = true; 
        resetBtn.textContent = "Confirm?";
        document.addEventListener("click", clickOutsideReset);
        return;
      }
      resetConfirm[asset.name] = false;
      counts[asset.name] = 0;
      render();
    };
    countRow.appendChild(resetBtn);

    // Scheduled toggle
    const schedBox = document.createElement("div");
    schedBox.className = "scheduled-box";
    schedBox.textContent = toggleState[asset.name] ? "Scheduled ▲" : "Scheduled ▼";
    schedBox.onclick = () => { toggleState[asset.name] = !toggleState[asset.name]; render(); };
    countRow.appendChild(schedBox);

    // Count display
    const countDisplay = document.createElement("input");
    countDisplay.className = "count";
    countDisplay.value = counts[asset.name];
    countDisplay.style.fontSize = "28px";
    countDisplay.style.textAlign = "center";
    countDisplay.style.width = "60px";
    countDisplay.onfocus = () => { if(countDisplay.value === "0") countDisplay.value = ""; };
    countDisplay.onblur = () => { counts[asset.name] = parseInt(countDisplay.value) || 0; countDisplay.value = counts[asset.name]; updateTotal(); };
    countDisplay.onclick = (e) => e.stopPropagation();
    countRow.appendChild(countDisplay);

    // +1 button
    const plusBtn = document.createElement("button");
    plusBtn.className = "plus-btn";
    plusBtn.textContent = "+1";
    plusBtn.onclick = () => { counts[asset.name]++; countDisplay.value = counts[asset.name]; updateTotal(); };
    countRow.appendChild(plusBtn);

    item.appendChild(countRow);

    // Interval pickers
    const intervalsDiv = document.createElement("div");
    intervalsDiv.className = "intervals";
    intervalsDiv.style.display = toggleState[asset.name] ? "block" : "none";
    
    asset.intervals.forEach(interval => {
      const intRow = document.createElement("div");
      intRow.className = "interval";
      const label = document.createElement("span");
      label.textContent = interval;
      const picker = document.createElement("input");
      picker.type = "month";
      picker.id = `${asset.name}_${interval}`;
      intRow.appendChild(label);
      intRow.appendChild(picker);
      intervalsDiv.appendChild(intRow);
    });
    
    item.appendChild(intervalsDiv);
    container.appendChild(item);
  });

  document.getElementById("totalCount").textContent = `Total Count: ${total}`;
}

function clickOutsideReset(e) {
  Object.keys(resetConfirm).forEach(key => resetConfirm[key] = false);
  resetAllConfirm = false;
  document.getElementById("resetAllBtn").textContent = "Reset All";
  render();
  document.removeEventListener("click", clickOutsideReset);
}

function updateTotal() {
    let total = 0;
    assets.forEach(a => total += counts[a.name]);
    document.getElementById("totalCount").textContent = `Total Count: ${total}`;
}

// Individual resetAll button with click-outside confirmation
const resetAllBtn = document.getElementById("resetAllBtn");
resetAllBtn.onclick = (e) => {
  e.stopPropagation();
  if (!resetAllConfirm) {
    resetAllConfirm = true;
    resetAllBtn.textContent = "Confirm?";
    document.addEventListener("click", clickOutsideReset);
    return;
  }
  resetAllConfirm = false;
  assets.forEach(a => counts[a.name] = 0);
  render();
};

// Download CSV
function downloadCSV() {
  let csv = `Site Name,${document.getElementById("siteName").value || ""}\n`;
  csv += `Date,${document.getElementById("date").value || ""}\n`;
  csv += "Asset,Count,Monthly,6 Monthly,Annual,5 Yearly,10 Yearly\n";

  assets.forEach(a => {
    let row = `"${a.name}",${counts[a.name] || 0}`;
    const schedules = ["Monthly","6 Monthly","Annual","5 Yearly","10 Yearly"];
    schedules.forEach(s => {
      const val = document.getElementById(`${a.name}_${s}`)?.value || "";
      let formattedVal = "";
      if (val) {
        const [year, month] = val.split("-");
        const monthName = new Date(year, month-1).toLocaleString('en-US', { month: 'short' });
        formattedVal = `${monthName}-${year}`;
      }
      row += `,${formattedVal}`;
    });
    csv += row + "\n";
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;

  const siteName = document.getElementById("siteName").value || "Site";
  const date = document.getElementById("date").value || "Date";
  const safeSiteName = siteName.replace(/\s+/g, "_");
  const safeDate = date.replace(/\s+/g, "_").replace(/\//g,"-");
  link.download = `${safeSiteName}_${safeDate}.csv`;
  link.click();
}

// Email CSV
function emailCSV() {
  const siteName = document.getElementById("siteName").value || "Site";
  const date = document.getElementById("date").value || "Date";
  const safeSiteName = siteName.replace(/\s+/g, "_");
  const safeDate = date.replace(/\s+/g, "_").replace(/\//g,"-");
  const subject = encodeURIComponent(`${safeSiteName}_${safeDate}`);
  window.location.href = `mailto:?subject=${subject}`;
}

window.onload = () => {
  const today = new Date();
  const dd = String(today.getDate()).padStart(2,'0');
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const yyyy = today.getFullYear();
  document.getElementById("date").value = `${dd}/${mm}/${yyyy}`;
  render();
}
</script>

</body>
</html>




