<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asset Tally</title>
<style>
  body { font-family: Arial, sans-serif; padding: 10px; background: #f4f4f4; }
  h2 { text-align: center; }
  .top-inputs input { width: 100%; padding: 8px; margin-bottom: 5px; font-size: 16px; box-sizing: border-box; }
  .asset-item { background: #007BFF; color: white; margin-bottom: 10px; padding: 10px; border-radius: 10px; }
  .countRow { display: flex; justify-content: flex-start; align-items: center; margin-top: 5px; flex-wrap: wrap; gap: 10px; }
  .reset-btn { background-color: #D70022; color: white; font-weight: bold; border: none; padding: 5px 10px; border-radius: 8px; font-size: 12px; cursor: pointer; }
  .scheduled-box { background-color: #FFD700; padding: 5px 8px; color: black; border-radius: 8px; font-weight: bold; cursor: pointer; text-align: center; min-width: 80px; font-size: 14px; }
  .count { font-size: 28px; font-weight: bold; width: 60px; text-align: center; }
  .plus-btn { font-size: 18px; background-color: #28a745; color: white; border: none; border-radius: 6px; padding: 5px 8px; cursor: pointer; }
  .intervals { margin-top: 5px; padding-left: 10px; }
  .interval { display: flex; justify-content: space-between; margin: 2px 0; }
  .interval input { width: 80px; }
  .control-btn { padding: 8px 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin: 5px; }
  .download-btn { background-color: #28a745; color: white; }
  .reset-all-btn { background-color: #D70022; color: white; }
  .total-count { font-size: 18px; font-weight: bold; text-align: center; margin-top: 10px; }
  .annual-flow { margin-top:5px; }
  .annual-flow label { display:block; margin-top:3px; }
  .annual-flow .note { display: inline-block; margin-top:5px; background-color: #FFD700; color: black; font-weight: bold; font-size: 13px; padding: 5px 8px; border-radius: 8px; }
  .annual-flow h3 { margin: 5px 0; font-size: 16px; }
  #smallSiteFee { text-align:center; font-weight:bold; margin-top:5px; }
  .checklist { margin-top:20px; padding:10px; background:#fff; border-radius:10px; }
  .checklist h3 { margin-bottom:10px; font-size:16px; }
</style>
</head>
<body>

<h2>Asset Tally</h2>
<div class="top-inputs">
  <input type="text" id="siteName" placeholder="Site Name / Address">
  <input type="date" id="date">
</div>

<div id="assetContainer"></div>

<div class="checklist" id="checklistDiv">
  <h3>Site Photos / Documentation / Final Checks</h3>
  <label><input type="checkbox"> Essential Services Cabinet</label><br>
  <label><input type="checkbox"> Switch Boards</label><br>
  <label><input type="checkbox"> FIP / EWIS</label><br>
  <label><input type="checkbox"> Inside FIP / EWIS</label><br>
  <label><input type="checkbox"> Batteries</label><br>
  <label><input type="checkbox"> Zone Block Plan</label><br>
  <label><input type="checkbox"> Pumpset</label><br>
  <label><input type="checkbox"> Sprinkler System / Valve Room</label><br>
  <label><input type="checkbox"> Sprinkler Block Plan</label><br>
  <label><input type="checkbox"> Inside Hydrant Booster Cabinet</label><br>
  <label><input type="checkbox"> Hydrant Block Plan</label><br>
  <label><input type="checkbox"> EVAC Diagrams</label><br>
  <label><input type="checkbox"> HVAC Switchboard</label><br>
  <label><input type="checkbox"> Lockbox Location</label><br>
  <label><input type="checkbox"> Service Dates</label><br>
  <label><input type="checkbox"> 5 / 10 / 25 Yearly Dates</label><br>
  <label><input type="checkbox"> Anything else notable</label>
</div>

<div style="margin-top:15px; text-align:center;">
  <button class="control-btn download-btn" onclick="downloadExcel()">Download Excel</button>
  <button class="control-btn reset-all-btn" id="resetAllBtn">Reset All</button>
</div>

<div class="total-count" id="totalCount">Total Count: 0</div>
<div id="smallSiteFee">Small Site Fee: No</div>

<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script>
const assets = [
  {
    name: "FIP",
    intervals:["Monthly","Annual","5 Yearly"],
    children: [
      {name: "No. Zones"},
      {name: "No. Smoke Detectors Common"},
      {name: "No. Smoke Detectors In units"},
      {name: "No. Heat Detectors Common"},
      {name: "No. Heat Detectors In Units"},
      {name: "No. Speakers Common"},
      {name: "No. Speakers In Units"},
      {name: "No. MCPs"},
      {name: "No. Duct Probes"},
      {name: "Mimic"},
      {name: "Vesda"},
      {name: "Fan Controls"},
      {name: "Interface Testing"},
      {name: "EWIS - No. Wips"},
      {name: "EWIS - No. Zones"},
    ]
  },
  {name: "Diesel Pumpset", intervals:["Monthly","6 Monthly","Annual","5 Yearly"]},
  {name: "Electric Pumpset", intervals:["Monthly","6 Monthly","Annual","5 Yearly"]},
  {name: "Sprinkler", intervals:["Monthly","6 Monthly","Annual","5 Yearly","10 Yearly","25 Yearly"]},
  {name: "Sprinkler - Flow Switches", intervals: []},
  {name: "Water Storage Tanks", intervals:["Monthly","6 Monthly","Annual","10 Yearly"]},
  {name: "Hydrants", intervals:["6 Monthly","Annual"]},
  {name: "Fire Hose Reels", intervals:["6 Monthly","Annual"]},
  {name: "Emergency & Exit Lights", intervals:["6 Monthly","Annual"]},
  {name: "E Light Test Facility - Switchboards", intervals:["Annual"]},
  {name: "Extinguishers", intervals:["6 Monthly","Annual"]},
  {name: "Blankets", intervals:["6 Monthly"]},
  {name: "Smoke & Heat Alarms", intervals:["6 Monthly","Annual"]},
  {name: "Fire Doors - Unit Doors", intervals:["6 Monthly","Annual"]},
  {name: "Fire Doors - Common Area", intervals:["6 Monthly","Annual"]},
  {name: "Sliding Fire Door", intervals:["Annual"]},
  {name: "RCD Testing", intervals:["Annual"]},
  {name: "Thermo Scanning", intervals:["Annual"]},
  {name: "Warden Training - FSA", intervals:["Annual"]},
  {name: "Compliance Inspection", intervals:["Annual"]},
  {name: "ERP/FEP Review", intervals:["Annual"]},
  {name: "Evac Drill", intervals:["Annual"]},
  {name: "Evac Diagrams - Update/Replace", intervals:["Annual"]},
  {name: "Mechanical Fan Testing", intervals:["Annual"]},
  {name: "Co2 Calibration", intervals:["Annual"]},
  {name: "Stairwell Pressurisation", intervals:["Annual"]},
  {name: "Install Essential Services Cavinet", intervals:[]},
];

const minutesPerAsset = {
  "No. Smoke Detectors Common":4,
  "No. Smoke Detectors In units":6,
  "No. Heat Detectors Common":4,
  "No. Heat Detectors In Units":6,
  "No. Speakers Common":2,
  "No. Speakers In Units":4,
  "No. MCPs":6,
  "No. Duct Probes":20,
  "Mimic":10,
  "Vesda":60,
  "Fan Controls":20,
  "Interface Testing":120,
  "EWIS - No. Wips":8
};

// Flow Test HTML
const flowTestHTML = `
<div class="annual-flow">
  <h3>Annual Flow Test</h3>
  <label><input type="checkbox" name="flowTest" value="Basic Internal"> Basic Internal</label>
  <label><input type="checkbox" name="flowTest" value="Basic External"> Basic External</label>
  <label><input type="checkbox" name="flowTest" value="Complex"> Complex*</label>
  <span class="note">
    *Over 10 stories, combined sprinkler/pump system, multiple pressure zones. Needs review by sprinkler fitter prior to emailing quote.
  </span>
</div>
`;

let counts = {};
let toggleState = {};
let resetConfirm = {};
let resetAllConfirm = false;

// --- Render UI ---
function render() {
  const container=document.getElementById("assetContainer");
  container.innerHTML="";

  assets.forEach(asset=>{
    counts[asset.name]=counts[asset.name]||0;
    toggleState[asset.name]=toggleState[asset.name]||false;
    resetConfirm[asset.name]=resetConfirm[asset.name]||false;

    const item=document.createElement("div");
    item.className="asset-item";

    const title=document.createElement("div");
    title.textContent=asset.name;
    title.style.fontWeight="bold";
    title.style.fontSize="18px";
    item.appendChild(title);

    const countRow=document.createElement("div");
    countRow.className="countRow";

    const resetBtn=document.createElement("button");
    resetBtn.className="reset-btn";
    resetBtn.textContent="Reset";
    resetBtn.onclick=(e)=>{
      e.stopPropagation();
      if(!resetConfirm[asset.name]){
        resetConfirm[asset.name]=true;
        resetBtn.textContent="Confirm?";
        document.addEventListener("click",clickOutsideReset);
        return;
      }
      resetConfirm[asset.name]=false;
      counts[asset.name]=0;
      updateTotal();
      render();
    };
    countRow.appendChild(resetBtn);

    const schedBox=document.createElement("div");
    schedBox.className="scheduled-box";
    schedBox.textContent=toggleState[asset.name]?"Scheduled ▲":"Scheduled ▼";
    schedBox.onclick=(e)=>{ e.stopPropagation(); toggleState[asset.name]=!toggleState[asset.name]; render(); };
    countRow.appendChild(schedBox);

    const countDisplay=document.createElement("input");
    countDisplay.className="count";
    countDisplay.value=counts[asset.name];
    countDisplay.onfocus=()=>{if(countDisplay.value==="0")countDisplay.value="";};
    countDisplay.onblur=()=>{counts[asset.name]=parseInt(countDisplay.value)||0; countDisplay.value=counts[asset.name]; updateTotal();};
    countDisplay.onclick=(e)=>e.stopPropagation();
    countRow.appendChild(countDisplay);

    const plusBtn=document.createElement("button");
    plusBtn.className="plus-btn";
    plusBtn.textContent="+1";
    plusBtn.onclick=()=>{ counts[asset.name]++; countDisplay.value=counts[asset.name]; updateTotal(); };
    countRow.appendChild(plusBtn);

    item.appendChild(countRow);

    // Intervals
    if(asset.intervals && asset.intervals.length>0 && toggleState[asset.name]){
      const intervalsDiv=document.createElement("div");
      intervalsDiv.className="intervals";
      asset.intervals.forEach(intv=>{
        const intDiv=document.createElement("div");
        intDiv.className="interval";
        intDiv.innerHTML=`${intv}: <input type="month" id="${asset.name}_${intv}">`;
        intervalsDiv.appendChild(intDiv);
      });
      item.appendChild(intervalsDiv);
    }

    // FIP children
    if(asset.children && toggleState[asset.name]){
      const childContainer=document.createElement("div");
      childContainer.style.marginLeft="20px";
      childContainer.style.marginTop="5px";

      asset.children.forEach(child=>{
        counts[child.name]=counts[child.name]||0;
        const childRow=document.createElement("div");
        childRow.className="countRow child-count-row";
        childRow.style.width="100%";

        const label=document.createElement("span");
        label.textContent=child.name;
        label.style.fontWeight="bold";
        label.style.flex="1";
        label.style.wordBreak="break-word";
        childRow.appendChild(label);

        const controlsDiv=document.createElement("div");
        controlsDiv.style.display="flex";
        controlsDiv.style.alignItems="center";
        controlsDiv.style.gap="5px";

        const countDisplay=document.createElement("input");
        countDisplay.className="count";
        countDisplay.value=counts[child.name];
        countDisplay.onfocus=()=>{if(countDisplay.value==="0")countDisplay.value="";};
        countDisplay.onblur=()=>{counts[child.name]=parseInt(countDisplay.value)||0; countDisplay.value=counts[child.name]; updateTotal();};

        const plusBtn=document.createElement("button");
        plusBtn.className="plus-btn";
        plusBtn.textContent="+1";
        plusBtn.onclick=()=>{ counts[child.name]++; countDisplay.value=counts[child.name]; updateTotal(); };

        controlsDiv.appendChild(countDisplay);
        controlsDiv.appendChild(plusBtn);

        childRow.appendChild(controlsDiv);
        childContainer.appendChild(childRow);
      });
      item.appendChild(childContainer);
    }

    container.appendChild(item);
  });

  // Insert Flow Test UI immediately under Hydrants
  const existingFlowDiv=document.getElementById("flowTestDiv");
  if(existingFlowDiv) existingFlowDiv.remove();
  const hydrantIndex=Array.from(container.children).findIndex(div=>div.textContent.includes("Hydrants"));
  if(hydrantIndex!==-1){
    const flowDivWrapper=document.createElement("div");
    flowDivWrapper.className="asset-item";
    flowDivWrapper.id="flowTestDiv";
    flowDivWrapper.innerHTML=flowTestHTML;
    container.insertBefore(flowDivWrapper, container.children[hydrantIndex+1]);
  }

  updateTotal();
}

// --- Click outside reset ---
function clickOutsideReset(e){
  Object.keys(resetConfirm).forEach(k=>resetConfirm[k]=false);
  resetAllConfirm=false;
  document.getElementById("resetAllBtn").textContent="Reset All";
  document.removeEventListener("click", clickOutsideReset);
  render();
}

// --- Update Total ---
function updateTotal(){
  const smallSiteAssets = ["Emergency & Exit Lights","Blankets","Extinguishers","Fire Hose Reels","Hydrants","Smoke & Heat Alarms"];
  const totalCountAssets = [...smallSiteAssets,"Fire Doors - Unit Doors","Fire Doors - Common Area"];

  let total=0;
  totalCountAssets.forEach(aName=>{ total+=counts[aName]||0; });
  document.getElementById("totalCount").textContent=`Total Count: ${total}`;

  const smallSiteTotal = smallSiteAssets.reduce((sum,name)=>sum+(counts[name]||0),0);
  document.getElementById("smallSiteFee").textContent=(smallSiteTotal<=59?"Small Site Fee: Yes":"Small Site Fee: No");
}

// --- Reset All Button ---
document.getElementById("resetAllBtn").onclick=(e)=>{
  e.stopPropagation();
  const btn=document.getElementById("resetAllBtn");
  if(!resetAllConfirm){
    resetAllConfirm=true;
    btn.textContent="Confirm?";
  } else {
    resetAllConfirm=false;
    Object.keys(counts).forEach(k=>counts[k]=0);
    Object.keys(toggleState).forEach(k=>toggleState[k]=false);
    btn.textContent="Reset All";
    render();
  }
};

// --- Download Excel ---
function downloadExcel(){
  const siteName=document.getElementById("siteName").value||"Unknown Site";
  const dateInput=document.getElementById("date").value;
  const date=dateInput ? dateInput.split("-").reverse().join("-") : "";
  const smallSiteText=document.getElementById("smallSiteFee").textContent.split(":")[1].trim();

  let ws_data=[["Site Name",siteName],["Date",date],["Small Site Fee",smallSiteText],[],["Asset","Count","Monthly","6 Monthly","Annual","5 Yearly","10 Yearly","25 Yearly","Minutes Per Asset"]];

  // --- Add Assets ---
  function processAsset(asset){
    const count=counts[asset.name]||0;
    const intervalColumns=["Monthly","6 Monthly","Annual","5 Yearly","10 Yearly","25 Yearly"];
    let intervalData=intervalColumns.map(intv=>{
      if(asset.intervals && asset.intervals.includes(intv)){
        const val=document.getElementById(`${asset.name}_${intv}`)?.value;
        if(val){
          const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
          const y=val.slice(0,4);
          const m=parseInt(val.slice(5,7),10)-1;
          return months[m]+"-"+y;
        }
        return "";
      }
      return "";
    });

    ws_data.push([asset.name,count,...intervalData,""]); // placeholder for Minutes Per Asset in next step

    // Children
    if(asset.children){
      asset.children.forEach(child=>{
        const cCount=counts[child.name]||0;
        const mins=minutesPerAsset[child.name]||"";
        ws_data.push([child.name,cCount,"","","","","","",mins]);
      });
    }
  }

  assets.forEach(asset=>processAsset(asset));

  // --- FIP Annual Minutes Row ---
  let fipTotal=0;
  const fipChildren=["No. Smoke Detectors Common","No. Smoke Detectors In units","No. Heat Detectors Common","No. Heat Detectors In Units","No. Speakers Common","No. Speakers In Units","No. MCPs","No. Duct Probes","Mimic","Vesda","Fan Controls","Interface Testing","EWIS - No. Wips"];
  fipChildren.forEach(name=>{
    const c=counts[name]||0;
    const m=minutesPerAsset[name]||0;
    fipTotal+=c*m;
  });
  ws_data.splice(3,0,["FIP Annual Minutes",fipTotal]);

  // --- Annual Flow Test Row inserted under Hydrants ---
  const hydrantRowIndex=ws_data.findIndex(r=>r[0]==="Hydrants")+1;
  const hydrants=counts["Hydrants"]||0;
  const pumps=(counts["Diesel Pumpset"]||0)+(counts["Electric Pumpset"]||0);
  const sprinklers=counts["Sprinkler"]||0;
  const flowChecks=Array.from(document.querySelectorAll('input[name="flowTest"]:checked')).map(e=>e.value);
  let flowText="",flowCount=0;

  // Flow Logic
  if(hydrants>0 && pumps===0 && sprinklers===0) flowCount=1;
  else if(hydrants>0 && pumps===1 && sprinklers===0) flowCount=1;
  else if(hydrants>0 && pumps===2 && sprinklers===0) flowCount=2;
  else if(hydrants>0 && pumps===3 && sprinklers===0) flowCount=3;
  else if(hydrants>0 && pumps===0 && sprinklers===1) flowCount=2;
  else if(hydrants>0 && pumps===1 && sprinklers===1) flowText="Requires Review";
  else if(hydrants>0 && pumps>=2 && sprinklers===1) flowText="Requires Review";
  else if(hydrants===0 && pumps===1 && sprinklers===0) flowCount=1;
  else if(hydrants===0 && pumps===2 && sprinklers===0) flowCount=2;
  else if(hydrants===0 && pumps===0 && sprinklers===1) flowCount=1;
  else if(hydrants===0 && pumps===1 && sprinklers===1) flowText="Requires Review";

  if(flowText!=="Requires Review") flowCount+=flowChecks.filter(v=>v!=="Complex").length;

  ws_data.splice(hydrantRowIndex,0,["Annual Flow Test",flowText||flowCount]);

  // --- Create Sheet & Workbook ---
  const ws=XLSX.utils.aoa_to_sheet(ws_data);

  ws['!cols']=[
    {wpx:237},{wpx:95},{wpx:95},{wpx:95},{wpx:95},{wpx:95},{wpx:95},{wpx:95},{wpx:126}
  ];

  // Alignment by column
  Object.keys(ws).forEach(r=>{
    if(r[0]!=="!"){
      const cell=ws[r];
      if(cell && cell.v!==undefined){
        const col=r.match(/[A-Z]+/)[0];
        if(col==="B") cell.s={alignment:{horizontal:"left"}};
        if(["C","D","E","F","G","H"].includes(col)) cell.s={alignment:{horizontal:"center"}};
      }
    }
  });

  // Hide rows 8–22
  ws['!rows']=[];
  for(let i=7;i<=21;i++) ws['!rows'][i]={hidden:true};

  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Assets");
  XLSX.writeFile(wb,`${siteName.replace(/ /g,"_")}_${date}.xlsx`);
}

// --- Set default date to today ---
const dateInput=document.getElementById("date");
const today=new Date();
const yyyy=today.getFullYear();
const mm=(today.getMonth()+1).toString().padStart(2,"0");
const dd=today.getDate().toString().padStart(2,"0");
dateInput.value=`${yyyy}-${mm}-${dd}`;

render();
</script>
</body>
</html>
